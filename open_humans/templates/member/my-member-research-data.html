{% extends 'member/my-member-dashboard.html' %}

{% load utilities %}

{% block dashboard_main %}
<div class="panel panel-default pad-all-sides">
  {% if 'twenty_three_and_me' in user.member.connections %}
  {% comment HIDE_23ANDME %}{% endcomment %}
  <p><strong>Note:</strong> We're still working out how we process 23andMe
    data. Any 23andMe data you've imported will be available on this page but
    can not be displayed publicly until we finalize our process.</p>

  <hr>
  {% endif %}

  {% for task in data_retrieval_tasks %}
  <h4>
    {{ task.source|source_to_name }}

    <a class="btn btn-xs btn-danger"
      href="{% url 'delete-data-retrieval-task' pk=task.pk %}">
      Delete task and files</a>
  </h4>

  {% if not task.complete_time %}
  <p>
    Submitted at {{ task.start_time }}: <b>{{ task.get_status_display }}</b>
  </p>
  {% else %}
    {% if task.data_files %}
    <table class="table">
      <tr>
        <th>Date</th>
        <th>File</th>
        <th>Downloads</th>
        <th>Actions</th>
      </tr>

      {% for data_file in task.data_files %}
      <tr>
        <td style="width: 23%;">{{ task.complete_time }}</td>

        <td style="width: 41%;">{{ data_file.basename }}</td>

        <td style="width: 10%;">
          {{ data_file.public_data_access.accesslog_set.count }}
        </td>

        <td style="width: 26%;">
          <a class="btn btn-primary btn-xs" href="{{ data_file.file.url }}">
            Download
          </a>
          {% if user.member.public_data_participant.enrolled %}
          <form action="{% url 'public-data:toggle-sharing' %}"
            method="POST" style="display: inline-block;">
            {% csrf_token %}

            <input type="hidden" name="data_file" value="{{ data_file.file }}">

            {% if data_file.public_data_access.is_public %}
              <input type="hidden" name="public" value="False">
            {% else %}
              <input type="hidden" name="public" value="True">
            {% endif %}

            <input class="btn btn-primary btn-xs"
              {% if data_file.public_data_access.is_public %}
                value="Stop public sharing"
              {% else %}
                value="Publicly share"
              {% endif %}
              type="submit">
          </form>
          {% else %} {# if user.member.public_data_participant.enrolled #}
          <a href="#" class="popover-dismiss btn btn-xs btn-info"
            role="button" tabindex="0"
            data-container="body" data-toggle="popover" data-placement="bottom"
            data-content="Only available to participants in the
              <a href='{% url 'public-data:home' %}'>Public Data Sharing</a> study.">
            Share publicly
          </a>
          {% endif %} {# if user.member.public_data_participant.enrolled #}
        </td>
      </tr>
      {% endfor %} {# data_file in task.data_files #}
    </table>
    {% else %}
    No data files created.
    {% endif %}
  {% endif %}
  {% endfor %}

  {% if failed %}
    <h4>Failed tasks</h4>

    <ul>
    {% for task in failed %}
      <li>{{ task.source|source_to_name }}
        - {{ task.start_time }}</li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if postponed %}
    <h4>Postponed tasks</h4>

    <p>Please <a href="{% url 'my-member-send-confirmation-email' %}">
      verify your email address here</a> to start these tasks.</p>

    <ul>
    {% for task in postponed %}
      <li>{{ task.source|source_to_name }}:
        Submitted at {{ task.start_time }}</li>
    {% endfor %}
    </ul>

  {% endif %}

  {% if not data_retrieval_tasks %}
  <hr>

  <p class="text-center">No data imports have been initiated.</p>
  {% endif %}
</div>

{% if not user.member.primary_email.verified %}

  <a href="#" class="btn btn-info popover-dismiss"
    role="button" tabindex="0"
    data-container="body" data-toggle="popover"
    data-placement="bottom"
    data-content="We'd like to make sure we can contact you. Please
      validate your email to enable data import!">
    Import data
  </a>

{% else %}

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Studies</h4>
    </div>
    <div class="panel-body">
      {% with user_data=user.american_gut %}
        {% include 'partials/connection-study.html' %}
      {% endwith %}
      <hr>
      {% with user_data=user.go_viral %}
        {% include 'partials/connection-study.html' %}
      {% endwith %}
      <hr>
      {% with user_data=user.pgp %}
         {% include 'partials/connection-study.html' %}
      {% endwith %}
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Activities</h4>
    </div>

    <div class="panel-body">
    {% with user_data=user.runkeeper %}
      {% include 'partials/connection-activity.html' %}
    {% endwith %}
    </div>
  </div>

{% endif %} {# if user.primary_email.validated is true #}

{% endblock dashboard_main %}
