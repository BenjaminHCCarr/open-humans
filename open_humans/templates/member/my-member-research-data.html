{% extends 'member/my-member-dashboard.html' %}

{% load data_import %}
{% load utilities %}

{% block head_title %}Research data{% endblock %}

{% block dashboard_main %}
<div class="panel panel-default pad-all-sides">
  {% for source, task in data_retrieval_tasks.items %}
    {% source_is_connected source user as is_connected %}
    {% source_is_disconnectable source as is_disconnectable %}
    {% source_is_individual_deletion source as is_individual_deletion %}

    {% if not forloop.first %}
      <hr class="source-divider">
    {% endif %}

    <div class="pull-right">
      {% if task.data_files %}
        {% if not is_connected %}
          <a href="{% url 'delete-source-data-files' source=source %}"
            class="btn btn-danger btn-xs">
            Delete all data files
          </a>
        {% endif %}

        {% if user.member.public_data_participant.enrolled %}
          <form class="toggle-sharing"
            action="{% url 'public-data:toggle-sharing' %}" method="POST"
            style="display: inline-block;">
            {% csrf_token %}

            <input type="hidden" name="source" value="{{ source }}">

            {% if task.is_public %}
              <input type="hidden" name="public" value="False">
            {% else %}
              <input type="hidden" name="public" value="True">
            {% endif %}

            <input class="btn btn-primary btn-xs"
              {% if task.is_public %}
                value="Stop public sharing"
              {% else %}
                value="Publicly share"
              {% endif %}
              type="submit">
          </form>
        {% else %} {# if user.member.public_data_participant.enrolled #}
          <a href="#" class="popover-dismiss btn btn-xs btn-info"
            role="button" tabindex="0"
            data-container="body" data-toggle="popover" data-placement="bottom"
            data-content="Only available to participants in the
              <a href='{% url 'public-data:home' %}'>Public Data Sharing</a> study.">
            Share publicly
          </a>
        {% endif %} {# if user.member.public_data_participant.enrolled #}
      {% endif %}
    </div>

    <h4 class="source-name">
      {{ source|source_to_name }}
    </h4>

    <p>
      Last updated: {{ task.complete_time }}
    </p>

    {% if task.data_files %}
      <table class="table file-table table-hover">
        <tr>
          <th>File</th>
          <th>Size</th>
          <th>Downloads</th>
          <th>Description</th>
        </tr>

        {% for data_file in task.data_files %}
          <tr>
            <td style="width: 40%;">
              <a href="{{ data_file.file.url }}">{{ data_file.basename }}</a>
            </td>

            <td style="width: 10%;">
              {{ data_file.size|filesizeformat }}
            </td>

            <td style="width: 10%;">
              {{ data_file.access_logs.count }}
            </td>

            <td>
              {{ data_file.description }}
            </td>
          </tr>
        {% endfor %} {# data_file in task.data_files #}
      </table>
    {% else %}
      <p>
        {% if task.status == DataRetrievalTask.TASK_SUCCEEDED %}
        There are no files associated with this source.
        {% elif task.status == DataRetrievalTask.TASK_FAILED %}
        Data processing for this source seems to have failed.
        {% else %}
        Data for this source is currently processing.
        {% endif %}
      </p>
    {% endif %}
  {% endfor %}

  {% if postponed %}
    <h4>Postponed tasks</h4>

    <p>Please <a href="{% url 'my-member-send-confirmation-email' %}">
      verify your email address here</a> to start these tasks.</p>

    <ul>
    {% for task in postponed %}
      <li>{{ task.source|source_to_name }}:
        Submitted at {{ task.start_time }}</li>
    {% endfor %}
    </ul>
  {% endif %}

  {% if not data_retrieval_tasks %}
  <hr>

  <p class="text-center">No data imports have been initiated.</p>
  {% endif %}
</div>

{% if not user.member.primary_email.verified %}

  <a href="#" class="btn btn-info popover-dismiss"
    role="button" tabindex="0"
    data-container="body" data-toggle="popover"
    data-placement="top"
    data-content="We'd like to make sure we can contact you. Please
      validate your email to enable data import!">
    Import data
  </a>

{% else %}

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Connect Data Sources</h4>
    </div>

    <div class="panel-body">
      <p>If you connect a source, Open Humans will import your data to our
        site. We will not use that connection to modify your account or profile
        on other websites (e.g. we will not post on your behalf).</p>
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Ongoing Studies</h4>
    </div>

    <div class="panel-body">
      {% with user_data=user.american_gut %}
        {% include 'partials/connection-study.html' %}
      {% endwith %}

      <hr>

      {% with user_data=user.go_viral %}
        {% include 'partials/connection-study.html' %}
      {% endwith %}

      <hr>

      {% with user_data=user.pgp %}
         {% include 'partials/connection-study.html' %}
      {% endwith %}
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Activities</h4>
    </div>

    <div class="panel-body">
      {% with user_data=user.twenty_three_and_me %}
        {% include 'partials/upload-activity.html' %}
      {% endwith %}

      <hr>

      {% with user_data=user.runkeeper %}
        {% include 'partials/connection-activity.html' %}
      {% endwith %}
    </div>
  </div>

  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">Closed Studies</h4>
    </div>
    <div class="panel-body">
      <p>
        Participants in these studies can connect their data to Open Humans,
        but the studies are no longer open for enrollment.
      </p>
      {% with user_data=user.wildlife %}
         {% include 'partials/connection-study.html' %}
      {% endwith %}
    </div>
  </div>

{% endif %} {# if user.primary_email.validated is true #}

<div class="pull-right">
  <a class="btn btn-default"
    role="button" href="{% url 'my-member-connections' %}">
    Manage data sources
  </a>
</div>
{% endblock dashboard_main %}
